{% set optional_opts = opts|rejectattr('required')|list %}
{% set required_opts = opts|selectattr('required')|list %}
{% set options_metavars %}
{%- if include_usage or switches %}
 [-
{%- if include_usage %}
h
{%- endif -%}
{%- for switch in switches %}
{{ switch.flag }}
{%- endfor -%}
]
{%- endif -%}
{%- for opt in optional_opts %}
 [-{{ opt.flag }} {{ opt.metavar }}]
{%- endfor -%}
{%- for opt in required_opts %}
 -{{ opt.flag }} {{ opt.metavar }}
{%- endfor -%}
{% endset %}
{% set update_verbosity %}
{% for switch in switches|selectattr('dest', 'equalto', 'verbosity') %}
{% if loop.first %}
VERBOSITY="$(printf '%s' "${verbosity{{ "[@]" if switch.additive else "" }}:-}")"
{% endif %}
{% endfor %}
{% endset %}
{% set getopts_str %}
{%- if include_usage -%}
h
{%- endif -%}
{{- switches|map(attribute='flag')|join -}}
{%- for opt in opts %}
{{ opt.flag }}{{ ':' if opt.metavar }}
{%- endfor -%}
{% endset %}
{{ function_name }}() {
	{% if update_verbosity %}
	local OLD_VERBOSITY
	{% endif %}
	local OPTIND
	local OPTARG
	local func_name
	{% if include_usage %}
	local {{ function_name }}_usage
	{% endif %}
	local required_opts
	local additive_opts
	local min_positional_args
	local max_positional_args
	local provided_opts
	local missing_opts

	{% for switch in switches %}
	local {{ switch.dest }}
	{% endfor %}
	{% for opt in opts %}
	local {{ opt.dest }}
	{% endfor %}

	{% for switch in switches %}
	{% if switch.additive %}
	{{ switch.dest }}=({{ '"{}"'.format(switch.default|join('" "')) if switch.default }})
	{% else %}
	{{ switch.dest }}="{{ switch.default }}"
	{% endif %}
	{% endfor %}
	{% for opt in opts %}
	{% if opt.additive %}
	{{ opt.dest }}=({{ '"{}"'.format(opt.default) if opt.default }})
	{% else %}
	{{ opt.dest }}="{{ opt.default }}"
	{% endif %}
	{% endfor %}

	{% if function_name != 'main' %}
	func_name="$PROGNAME:$FUNCNAME"
	{% else %}
	func_name="$PROGNAME"
	{% endif %}
	{% if include_usage %}

	{{ function_name }}_usage() {
		cat <<EOF | sed 's/^\t\t//' >&2
		NAME
			${func_name} -- {{ short_description }}

		SYNOPSIS
			${func_name}{{ options_metavars }}{{ positional_args_metavars }}

		DESCRIPTION
			{{ description }}

			The options are as follows:

			-h	print this help and exit

			{% for switch in switches %}
			-{{ switch.flag }}	{{ switch.description }}
				{%- if switch.default +%} (default: {{ switch.default }})
				{%- endif %}

				{% if switch.additive %}
				may be given more than once
				{% endif %}

			{% endfor %}
			{% for opt in opts %}
			-{{ opt.flag }} {{ opt.metavar }}
				{{ '(required) ' if opt.required }}{{ opt.description }}
				{%- if opt.default +%} (default: {{ opt.default }})
				{%- endif %}

				{% if opt.additive %}
				may be given more than once
				{% endif %}

			{% endfor %}
			{% if positional_args_help %}
			{{ positional_args_help }}
			{% endif %}
EOF
	}
	{% endif %}

	# options which must be given
	required_opts=(
		{%- for flag in required_opts|map(attribute='flag') -%}
		"{{ flag }}"{{ ' ' if not loop.last }}
		{%- endfor -%}
	)
	# options which may be given more than once
	additive_opts=(
		{%- for flag in switches|selectattr('additive')|map(attribute='flag') -%}
		"{{ flag }}"{{ ' ' if not loop.last or opts|selectattr('additive')|list }}
		{%- endfor -%}
		{%- for flag in opts|selectattr('additive')|map(attribute='flag') -%}
		"{{ flag }}"{{ ' ' if not loop.last }}
		{%- endfor -%}
	)
	# minimum number of positional arguments allowed (ignored if empty)
	min_positional_args="{{ min_positional_args if min_positional_args > 0 }}"
	# maximum number of positional arguments allowed (ignored if empty)
	max_positional_args="{{ max_positional_args if max_positional_args > 0}}"

	# tracks which options have been provided
	provided_opts=()
	while getopts '{{ getopts_str }}' opt; do
		if ! contains_value "$opt" "${additive_opts[@]:-}" && contains_value "$opt" "${provided_opts[@]:-}"; then
			log_error "option cannot be given more than once: $opt"
			{% if include_usage %}
			{{ function_name }}_usage
			{% endif %}
			exit 1
		fi

		case "$opt" in
			{% if include_usage %}
			h)
				{{ function_name }}_usage
				exit 0
				;;
			{% endif %}
			{% for switch in switches %}
			{{ switch.flag }})
				{% if switch.additive %}
				{{ switch.dest }}+=("{{ switch.value if switch.value else 'y' }}")
				{% else %}
				{{ switch.dest }}="{{ switch.value if switch.value else 'y' }}"
				{% endif %}
				;;
			{% endfor %}
			{% for opt in opts %}
			{{ opt.flag }})
				{% if opt.additive %}
				{{ opt.dest }}+=("$OPTARG")
				{% else %}
				{{ opt.dest }}="$OPTARG"
				{% endif %}
				;;
			{% endfor %}
			*)
				{% if include_usage %}
				{{ function_name }}_usage
				{% endif %}
				exit 1
				;;
		esac
		provided_opts+=("$opt")
	done
	shift $((OPTIND - 1))

	{% if update_verbosity %}
	OLD_VERBOSITY="${VERBOSITY:-}"
	{{ update_verbosity }}
	{% endif %}

	if [ -n "$min_positional_args" ] && [ "$#" -lt "$min_positional_args" ]; then
		log_error "at least ${min_positional_args} positional argument(s) needed but got only $#: $*"
		{% if include_usage %}
		{{ function_name }}_usage
		{% endif %}
		exit 1
	fi
	if [ -n "$max_positional_args" ] && [ "$#" -gt "$max_positional_args" ]; then
		log_error "up to ${max_positional_args} positional argument(s) allowed but got $#: $*"
		{% if include_usage %}
		{{ function_name }}_usage
		{% endif %}
		exit 1
	fi

	if [ "{{'${#required_opts[@]}'}}" -gt "0" ]; then
		missing_opts=()
		for opt in "${required_opts[@]}"; do
			if ! contains_value "$opt" "${provided_opts[@]:-}"; then
				missing_opts+=("${opt}")
			fi
		done
		if [ "{{'${#missing_opts[@]}'}}" -gt "0" ]; then
			log_error "missing required options: ${missing_opts[*]}"
			{% if include_usage %}
			{{ function_name }}_usage
			{% endif %}
			exit 1
		fi
	fi

	{% for switch in switches %}
	{% if switch.additive %}
	log_debug "{{ switch.dest }}: {{ '${%s[*]:-}'|format(switch.dest) }}"
	{% else %}
	log_debug "{{ switch.dest }}: {{ '${%s:-}'|format(switch.dest) }}"
	{% endif %}
	{% endfor %}
	{% for opt in opts %}
	{% if opt.additive %}
	if [[ "{{ '${#%s[@]}'|format(opt.dest) }}" -gt "0" ]]; then
		log_debug "{{ opt.dest }}: $(printf '\n\t"%s"' "{{ '${%s[@]:-}'|format(opt.dest) }}")"
	fi
	{% else %}
	log_debug "{{ opt.dest }}: {{ '${%s:-}'|format(opt.dest) }}"
	{% endif %}
	{% endfor %}
	{% if max_positional_args != 0 %}
	if [[ "$#" -gt "0" ]]; then
		log_debug "positional args: $(printf '\n\t"%s"' "$@")"
	else
		log_debug 'no positional args given'
	fi
	{% endif %}

	{% if update_verbosity %}
	VERBOSITY="${OLD_VERBOSITY:-}"
	{% endif %}
}
